using System.Collections;
using System.Collections.Generic;
using System.IO;
using UnityEngine;

//-----------------------------------------------------------------------------------------------------------------------------------
// 사업체 정보를 처리하기 위한 클래스
//-----------------------------------------------------------------------------------------------------------------------------------
public class CBusiness : MonoBehaviour
{
	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
    [System.Serializable]
    public class tagData
    {
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		public List<tagBusiness>	Businesses		= new List<tagBusiness>();
		public List<string>			Reserves		= new List<string>();

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		public List<string>			Favorites		= new List<string>();

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
    };
    public tagData		data		= new tagData();

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	protected CApp		app			= (null);
	protected CPlay		play		= (null);

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	void OnEnable()
	{
		(this.app)		= (CApp.This);
		(this.play)		= (CPlay.This);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	void Start()
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( Directory.Exists(GetFavoritesPath()) )
		{
			string[] dirArray = Directory.GetFiles(GetFavoritesPath());
			foreach( string dir in dirArray )
			{
				data.Favorites.Add( Func.GetFileName(dir) );
			}
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	void Update()
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (Reserves().Count)>(0) )
		{
			ManagementHash.RequestBusiness( Reserves() );
			Reserves().Clear();
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		Enable( false );

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 사업체 정보를 등록하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagBusiness Register( AppsParameter col )
    {
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
        if( (col)==(null) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		tagBusiness business = Find(col.Get("id"));
		if( (business)==(null) )
		{
			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
			(business)	= new tagBusiness();
			GetList().Add( business );

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
			(business.id)				= col.Get("id");
			(business.businessstatic)	= app.BusinessStatic.Find(col.Get("type"));		//사업체 유형
			(business.citystatic)		= app.CityStatic.Find(col.Get("city"));			//소재 도시

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		app.Company.Set( ref business.company, col.Get("company") );	//소유 기업
		app.Person.Set( ref business.manager, col.Get("manager") );		//관리자

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		(business.since)	= col.GetInt("since");		//창업 이래
		(business.process)	= col.GetLong("process");

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( true )
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			string product = col.Get("product");
			if( Func.Is(product) && ( !Apps.Is(business.product) || (business.product.id)!=(product) ) )
			{
				(business.product)	= app.ProductStatic.Find(col.Get("product"));
			}

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			(business.product_id) = col.Get("product_id");

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------\
		return (business);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 리스트를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public List<tagBusiness> GetList()
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (data.Businesses);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 리스트를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagBusiness Find( string id )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( !Func.Is(id) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		foreach( tagBusiness business in GetList() )
		{
			if( (business.id)==(id) )
			{
				return (business);
			}
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (null);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 사업체에 권한이 있는지 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public bool IsRight( tagBusiness business )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (business)==(null) ) return false;

		//---------------------------------------------------------------------------------------------------------------------------
		// 소유 기업 (COMPANY)
		//---------------------------------------------------------------------------------------------------------------------------
		if( app.Company.Is(business.Company()) && business.Company()==app.Identity.Company() )
		{
			return true;
		}
		else
		if( !app.Company.Is(business.Company()) )
		{
			Debug.LogWarning("기업이 확인되지 않음 : "+(business.company));
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// 관리자 (MANAGER)
		//---------------------------------------------------------------------------------------------------------------------------
		if( (business.manager)==app.Player.Person() )
		{
			return true;
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// 소유주 (OWNER)
		//---------------------------------------------------------------------------------------------------------------------------
//		if( app.Company.IsManager(business.Company(), app.Player.Person()) )
		if( app.Company.IsRight(business.Company()) )
		{
			return true;
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return false;
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 부서를 개설할 수 있는지 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagBusiness Get()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( app.ViewBusiness.Is(true) )
		{
			return app.ViewBusiness.Get();
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return (null);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 사업체 정보를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagBusiness Get( ref object obj )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (obj)==(null) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( obj.GetType()==typeof(tagBusiness) )
		{
			return (obj as tagBusiness);
		}
		else
		if( obj.GetType()==typeof(string) )
		{
			tagBusiness business = app.Business.Find(obj as string);
			if( (business)!=(null) )
			{
				(obj)	= (business);
				return (business);
			}
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (null);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 부서를 개설할 수 있는지 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public bool IsDepartment( tagBusiness business, tagDepartmentStatic departmentstatic )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (business)==(null) ) return false;
		if( (departmentstatic)==(null) ) return false;

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		switch( business.businessstatic.Type )
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// 농장 (FARM)
			//-----------------------------------------------------------------------------------------------------------------------
			case (UPDATE_TYPE.Farm):
				switch( departmentstatic.id )
				{
					case (DEPARTMENT.재배부):
					case (DEPARTMENT.사육부):
					case (DEPARTMENT.가공부):
					case (DEPARTMENT.재고부):
					case (DEPARTMENT.판매부):
					case (DEPARTMENT.상표부):
					case (DEPARTMENT.광고부):
						return true;
				}
				break;

			//-----------------------------------------------------------------------------------------------------------------------
			// 공장 (FACTORY)
			//-----------------------------------------------------------------------------------------------------------------------
			case (UPDATE_TYPE.Factory):
				switch( departmentstatic.id )
				{
					case (DEPARTMENT.구매부):
					case (DEPARTMENT.제조부):
					case (DEPARTMENT.재고부):
					case (DEPARTMENT.판매부):
					case (DEPARTMENT.상표부):
					case (DEPARTMENT.광고부):
						return true;
				}
				break;

			//-----------------------------------------------------------------------------------------------------------------------
			// 소매점 (MARKET)
			//-----------------------------------------------------------------------------------------------------------------------
			case (UPDATE_TYPE.Market):
				switch( departmentstatic.id )
				{
					case (DEPARTMENT.구매부):
					case (DEPARTMENT.재고부):
					case (DEPARTMENT.판매부):
					case (DEPARTMENT.상표부):
					case (DEPARTMENT.광고부):
						return true;
				}
				break;

			//-----------------------------------------------------------------------------------------------------------------------
			// 자원 채취 (PIT)
			//-----------------------------------------------------------------------------------------------------------------------
			case (UPDATE_TYPE.Pit):
				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
				if( (business.businessstatic.id)==(BUSINESS.유전) && (departmentstatic.id)==(DEPARTMENT.채취부) )
				{
					return true;
				}
				else
				if( (business.businessstatic.id)==(BUSINESS.벌목장) && (departmentstatic.id)==(DEPARTMENT.벌목부) )
				{
					return true;
				}

				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
				switch( departmentstatic.id )
				{
					case (DEPARTMENT.재고부):
					case (DEPARTMENT.판매부):
						return true;
				}

				//-------------------------------------------------------------------------------------------------------------------
				// -
				//-------------------------------------------------------------------------------------------------------------------
				break;

			//-----------------------------------------------------------------------------------------------------------------------
			// 연구소 (LABORATORY)
			//-----------------------------------------------------------------------------------------------------------------------
			case (UPDATE_TYPE.Laboratory):
				switch( departmentstatic.id )
				{
					case (DEPARTMENT.연구부):
						return true;
				}
				break;

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return false;
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	public void funcBuild( object wParam=(null), object lParam=(null) )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( app.Business.GetRightCount()>=(SYSTEM.BUSINESS_BUILD_LIMIT) )
		{
			app.Confirm.ON(  Func.Script( app.Language.Get(TEXT.테스트_기간_중에는_사업체를__개_이상_건설할_수_없습니다), SYSTEM.BUSINESS_BUILD_LIMIT.ToString() ) );
			return;
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( app.Identity.IsPerson() )
		{
			app.Confirm.ON( app.Language.Get(TEXT.사업체를_건설하려면_먼저_기업을_선택하세요), (CONFIRM.YESNO), (app.ViewIdentityList.funcON) );
			return;
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( Apps.Is(app.City.Get()) )
		{
			if( (app.City.Get().openmarket) || app.City.Get().Nation()==app.Identity.Nation() )
			{
				app.ViewBuildList.ON();
			}
			else
			{
				app.Confirm.ON( app.Language.Get(TEXT.이_도시에서_사업체_건설을_허가받지_못했습니다) );
			}
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 기업 정보 요청을 예약하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Reserve( string id )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( !Func.Is(id) ) return;

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( !Reserves().Contains(id) )
		{
			Reserves().Add( id );
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (Reserves().Count)>(0) )
		{
			Enable();
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 예약 리스트를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public List<string> Reserves()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return (data.Reserves);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 기업 정보 요청을 예약하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	void Enable( bool enable=(true) )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (enabled)!=(enable) )
		{
			(enabled)	= (enable);
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 기업 정보를 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public bool Is( tagBusiness business )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (business)==(null) ) return false;

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( Func.Is(business.id) )
		{
			return true;
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return false;
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 사업체 정보를 초기화 하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Release( tagBusiness business )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (business)==(null) ) return;

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		GetList().Remove( business );

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 즐겨찾기를 처리하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Favorite( tagBusiness business, bool value )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( !Is(business) ) return;

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( value )
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			if( !data.Favorites.Contains(business.id) )
			{
				data.Favorites.Add( business.id );
			}

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			Func.CreateDirectory( GetFavoritesPath() );
			Func.WriteAllBytes( GetFavoritesPath()+"/"+(business.id), new byte[0] );

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}
		else
		{
			Func.Delete( GetFavoritesPath()+"/"+(business.id) );
			data.Favorites.Remove(business.id);
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	string GetFavoritesPath()
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return CEngine.GetPath()+"/Business-Favorites";

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 즐겨찾기를 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public bool IsFavorite( tagBusiness business )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( !Is(business) ) return false;

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return data.Favorites.Contains(business.id);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Graph( tagBusiness business, GRAPH nGraph, int date, float value )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (business)==(null) ) return;
		if( (nGraph)==(GRAPH.NOTHING) ) return;
		if( (date)==(0) ) return;

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		tagGraphValue graphValue = business.Find( (nGraph), (date) );
		if( (graphValue)==(null) )
		{
			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
			(graphValue) = new tagGraphValue();
			business.GraphValues.Add(graphValue);

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
			(graphValue.nGraph)	= (nGraph);
			(graphValue.date)	= (date);

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		(graphValue.value)	= (value);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 소유한 사업체 수를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public int GetRightCount()
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		int	Count = (0);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		foreach( tagBusiness business in GetList() )
		{
			if( IsRight(business) )
			{
				(Count) += (1);
			}
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (Count);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
}

//-----------------------------------------------------------------------------------------------------------------------------------
// -
//-----------------------------------------------------------------------------------------------------------------------------------