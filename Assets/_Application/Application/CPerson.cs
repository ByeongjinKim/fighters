using System.Collections;
using System.Collections.Generic;
using UnityEngine;

//-----------------------------------------------------------------------------------------------------------------------------------
// 인물 정보를 처리하기 위한 클래스
//-----------------------------------------------------------------------------------------------------------------------------------
public class CPerson : MonoBehaviour
{
	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
    [System.Serializable]
    public class tagData
    {
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		public List<tagPerson>		Persons		= new List<tagPerson>();
		public List<string>			Reserves	= new List<string>();

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
    };
    public tagData		data		= new tagData();

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	protected CApp		app			= (null);
	protected CPlay		play		= (null);

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	void OnEnable()
	{
		(this.app)		= (CApp.This);
		(this.play)		= (CPlay.This);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	void Update()
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (Reserves().Count)>(0) )
		{
			ManagementHash.RequestPerson( Reserves() );
			Reserves().Clear();
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		Enable( false );

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 인물 정보를 등록하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagPerson Register( AppsParameter col )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (col)==(null) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		tagPerson person = Find(col.Get("id"));
		if( (person)==(null) )
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			(person) = new tagPerson();

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			(person.id)		= col.Get("id");
			(person.name)	= col.Get("name");

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			GetList().Add(person);

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (person)!=(null) )
		{
			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
			(person.nation) = app.NationStatic.Find(col.Get("nation"));

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
			if( Func.Is(col.Get("city")) )
			{
				tagCityStatic city = app.City.Find(col.Get("city"));
				if( (city)!=(null) )
				{
					(person.city) = (city);
				}
			}

			//-----------------------------------------------------------------------------------------------------------------------
		    // 이미지
		    //-----------------------------------------------------------------------------------------------------------------------
			long picture_upload_time = col.GetLong("picture_upload_time");
			if( GetPictureTime(person)<(picture_upload_time) )
			{
				PictureDownload( (person), col.Get("picture"), (picture_upload_time) );
			}
			else
			if( Func.IsFile(GetPicturePath(person)) )
			{
				/*
				(person.picture)	= new tagTexture(GetPicturePath(person));
				if( (person.picture)!=(null) )
				{
					(person.picture.cache)	= Func.GetFileModifyTime(GetPicturePath(person));
				}
				*/
			}

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
			(person.avatar.body)		= app.AvatarStatic.Find(col.Get("avatar_body"));
			(person.avatar.face)		= app.AvatarStatic.Find(col.Get("avatar_face"));
			(person.avatar.hair)		= app.AvatarStatic.Find(col.Get("avatar_hair"));
			(person.avatar.kit)			= app.AvatarStatic.Find(col.Get("avatar_kit"));
			(person.avatar.backcolor)	= app.AvatarStatic.Find(col.Get("avatar_backcolor"));

			//-----------------------------------------------------------------------------------------------------------------------
		    // 기업을 설정함
		    //-----------------------------------------------------------------------------------------------------------------------
			app.Company.Set( ref person.company, col.Get("company") );

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
//			(person.property)	= col.GetDecimal("property");

			//-----------------------------------------------------------------------------------------------------------------------
		    // -
		    //-----------------------------------------------------------------------------------------------------------------------
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (person);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 리스트를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public List<tagPerson> GetList()
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (data.Persons);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 인물 정보를 검색하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagPerson Find( string id )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( !Func.Is(id) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		foreach( tagPerson person in GetList() )
		{
			if( (person.id)==(id) )
			{
				return (person);
			}
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (null);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 이름을 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public string GetName( tagPerson person )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (person)==(null) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (person.name);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// ID를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public string GetID( tagPerson person )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (person)==(null) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (person.id);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 인물 정보를 확인하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public bool Is( tagPerson person )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (person)==(null) ) return false;

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( Func.Is(person.id) )
		{
			return true;
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return false;
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 경영인 정보를 설정하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Set( ref object _person, string id )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( !Func.Is(id) ) return;

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		tagPerson person = app.Person.Find(id);
		if( (person)!=(null) )
		{
			(_person) = (person);
		}
		else
		{
			(_person) = (id);
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 경영인 정보를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public tagPerson Get( ref object obj )
	{
	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( (obj)==(null) ) return (null);

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		if( obj.GetType()==typeof(tagPerson) )
		{
			return (obj as tagPerson);
		}
		else
		if( obj.GetType()==typeof(string) )
		{
			tagPerson person = app.Person.Find(obj as string);
			if( (person)!=(null) )
			{
				(obj)	= (person);
				return (person);
			}
		}

	    //---------------------------------------------------------------------------------------------------------------------------
        // -
	    //---------------------------------------------------------------------------------------------------------------------------
		return (null);
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 기업 정보 요청을 예약하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public void Reserve( string id )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( !Func.Is(id) ) return;

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( !Reserves().Contains(id) )
		{
			Reserves().Add( id );
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (Reserves().Count)>(0) )
		{
			Enable();
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 예약 리스트를 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	public List<string> Reserves()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return (data.Reserves);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 기업 정보 요청을 예약하기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	void Enable( bool enable=(true) )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (enabled)!=(enable) )
		{
			(enabled)	= (enable);
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 이미지 캐시 시간을 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	long GetPictureTime( tagPerson person )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( !Is(person) ) return (0);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (person.picture)!=(null) )
		{
			return (person.picture.cache);
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return Func.GetFileModifyTime(GetPicturePath(person));
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 이미지 캐시 시간을 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	string GetPicturePath()
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return CEngine.GetPath()+"/Person-Pictures";

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// 이미지 캐시 시간을 얻기 위한 함수
	//-------------------------------------------------------------------------------------------------------------------------------
	string GetPicturePath( tagPerson person )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( !Is(person) ) return (null);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		return GetPicturePath()+"/"+(person.id)+".jpg";
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	public void PictureDownload( tagPerson person, string Url, long cache )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (person)==(null) ) return;
		if( !Func.Is(Url) ) return;

		/*
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		tagDownload download = app.Download.ON( new tagTexture(Url), (funcPictureDownload), (person) );
		if( (download)!=(null) && (download.texture)!=(null) )
		{
			(download.texture.cache)			= (cache);
			(download.texture.isStreamingSave)	= (false);
			(download.texture.isCacheSave)		= (false);
			(download.texture.isBinaryLoad)		= (true);
		}
		*/

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
	void funcPictureDownload( object wParam=(null), object lParam=(null) )
	{
		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (wParam)==(null) || wParam.GetType()!=typeof(tagPerson) ) return;
		if( (lParam)==(null) || lParam.GetType()!=typeof(tagTexture) ) return;

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		tagPerson	person		= (wParam as tagPerson);
		tagTexture	texture		= (lParam as tagTexture);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		(person.picture)	= (texture);

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( true )
		{
			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			Object[] objArray = (null);

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
			if( (person.avatar)==(null) || !person.avatar.Is() )
			{
				(objArray) = FindObjectsOfType( typeof(uiPerson), (true) );
				foreach( uiPerson icon in objArray )
				{
					if( icon.Get()==(person) )
					{
						(icon.Image().texture)	= texture.GetTexture();
					}
				}
			}

			//---------------------------------------------------------------------------------------------------------------------------
			// -
			//---------------------------------------------------------------------------------------------------------------------------
			(objArray) = FindObjectsOfType( typeof(uiIdentity), (true) );
			foreach( uiIdentity icon in objArray )
			{
				if( icon.Person()==(person) )
				{
					(icon.Image().texture)	= texture.GetTexture();
				}
			}

			//-----------------------------------------------------------------------------------------------------------------------
			// -
			//-----------------------------------------------------------------------------------------------------------------------
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
		if( (texture.bytes)!=(null) )
		{
			Func.CreateDirectory(GetPicturePath());
			Func.WriteAllBytes( GetPicturePath(person), (texture.bytes) );
			(texture.bytes)	= (null);
		}

		//---------------------------------------------------------------------------------------------------------------------------
		// -
		//---------------------------------------------------------------------------------------------------------------------------
	}

	//-------------------------------------------------------------------------------------------------------------------------------
	// -
	//-------------------------------------------------------------------------------------------------------------------------------
}

//-----------------------------------------------------------------------------------------------------------------------------------
// -
//-----------------------------------------------------------------------------------------------------------------------------------